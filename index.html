<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=90b8e6fd2a9909e4b0de7508dd8dcb62&libraries=services"></script>

    <style>
        body {
            width: 100%;
            margin: 30px;
        }

        #content #map {
            height: 500px;
            width: 500px;
            float: right;
            margin-right: 100px;
        }
    </style>

</head>
<body>
    <header id="header">
        <h1>kakao 맛집 검색</h1>
    </header>
    <content id="content">
        <nav class="search-container">
            <form id="searchForm">
                <input type="search" id="query" placeholder="키워드를 입력해주세요" />
                <button type="submit">검색</button>
            </form>
        </nav>
    
        <div class="list-container">
            <ul id="list"></ul>
        </div>
    
        <div class="map_container">
            <div id="map">
            </div>
        </div>
    </content>
    <footer id="footer"></footer>

    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=90b8e6fd2a9909e4b0de7508dd8dcb62&libraries=services"></script>
    <script>
      function get_map_search(query) {
        const xhr = new XMLHttpRequest();
        const method = "GET";
        const url =
          "https://dapi.kakao.com/v2/local/search/keyword.json?query=" + query;

        xhr.onreadystatechange = (e) => {
          const { target } = e;

          if (target.readyState == XMLHttpRequest.DONE) {
            if (target.status == 200) {
              const req = JSON.parse(target.response);
              const listBody = document.querySelector("#list");
              listBody.innerHTML = "";
              req.documents.map((v, i) => {
                console.log(v);

            // 장소 검색 객체를 생성합니다
        var ps = new kakao.maps.services.Places(); 
        // 키워드로 장소를 검색
        
        ps.keywordSearch(query + ' ', placesSearchCB);

        // 키워드 검색 완료 시 호출되는 콜백함수
        function placesSearchCB (data, status, pagination) {
            if (status === kakao.maps.services.Status.OK) {
                var bounds = new kakao.maps.LatLngBounds();
                
                for (let i=0; i<data.length; i++) {
                    displayMarker(data[i]);
                    bounds.extend(new kakao.maps.LatLng(data[i].y, data[i].x));
                }

                // 검색된 장소 위치를 기준으로 지도 범위를 재설정
                map.setBounds(bounds);

            }
        }

        
    // 지도에 마커를 표시하는 함수입니다
    function displayMarker(place) {

        // 마커를 생성하고 지도에 표시합니다
        var marker = new kakao.maps.Marker({
            map: map,
            position: new kakao.maps.LatLng(place.y, place.x) 
        });

        // 마커에 클릭이벤트를 등록합니다
        kakao.maps.event.addListener(marker, 'click', function() {
            // 마커를 클릭하면 장소명이 인포윈도우에 표출됩니다
            infowindow.setContent('<div style="padding:5px;font-size:12px;">' + place.place_name + '</div>');
            infowindow.open(map, marker);
        });
    }

              });
            } else {
              const s = parseInt(target.status / 100);
              let errMsg = null;
              if (s == 4) {
                errMsg =
                  "[" +
                  target.status +
                  "]" +
                  target.statusText +
                  "-요청 주소가 잘못되었습니다.";
              } else if (s == 5) {
                errMsg =
                  "[" +
                  target.status +
                  "]" +
                  target.statusText +
                  "-서버의 응답이 없습니다.";
              } else {
                errMsg =
                  "[" +
                  target.status +
                  "]" +
                  target.statusText +
                  "-요청에 실패했습니다.";
              }
              alert(errMsg);
            }
          }
        };

        xhr.open(method, url);
        xhr.setRequestHeader(
          "Authorization",
          "KakaoAK fc4ae9f65a8ff5a3a85b0ed5a6cf19cd"
        );
        xhr.send();
      }
      document.querySelector("#searchForm").addEventListener("submit", (e) => {
        e.preventDefault();
        const queryField = document.querySelector("#query");
        const query = queryField.value.trim();

        console.log(query);
        if (!query) {
          alert("검색하세요");
          queryField.focus();
          return;
        }
        get_map_search(query);
      });
    
   
        const map_display = document.getElementById('map'),
              options = {
                        center: new kakao.maps.LatLng(37.566826, 126.9786567),
                        level: 3
                        };
                            
        // 지도를 생성합니다    
        var map = new kakao.maps.Map(map_display, options); 

        
    </script>
</body>
</html>