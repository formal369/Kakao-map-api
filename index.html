<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=90b8e6fd2a9909e4b0de7508dd8dcb62&libraries=services"></script>

    <style>
        body {
            width: 100%;
            margin: 30px;
        }
        .clearfix {
            float : none;
            display: block;
            content : '';
            clear: both;
        }

        #content #map {
            height: 700px;
            width: 500px;
            float: right;
            margin-right: 100px;
        }
        ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        #list li{
            width: 300px;
            
            border-bottom: 1px dotted gray;
            margin: 10px;
        }
       
        #list li a {
            text-decoration: none;
            color: black;
            display: block;
        }
        #list li span {
            display: block;
            font-size: 14px;
            padding: 5px 10px;
            text-align: center;
            
            height: 10px;
        }
        
        .list-container {
            width: 400px;
        }
        
    </style>

</head>
<body>
    <header id="header">
        <h1>kakao 맛집 검색</h1>
    </header>
    <content id="content">
        <nav class="search_container">
            <form id="searchForm">
                <input type="search" id="query" placeholder="키워드를 입력해주세요" />
                <button type="submit">검색</button>
            </form>
        </nav>
    
        <div class="list_container">
            <ul id="list"></ul>
        </div>
    
        <div class="map_container">
            <div id="map">
            </div>
            <button type="button" id="loc_btn">현재 위치에서 검색</button>
        </div>
    </content>
    <footer id="footer"></footer>

    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=90b8e6fd2a9909e4b0de7508dd8dcb62&libraries=services"></script>
    <script>
      function get_map_search(query) {
        const xhr = new XMLHttpRequest();
        const method = "GET";
        const url =
          "https://dapi.kakao.com/v2/local/search/keyword.json?query=" + query;

        xhr.onreadystatechange = (e) => {
          const { target } = e;

          if (target.readyState == XMLHttpRequest.DONE) {
            if (target.status == 200) {
              const req = JSON.parse(target.response);
              const listBody = document.querySelector("#list");
              listBody.innerHTML = "";
              req.documents.map((v, i) => {
                console.log(v);


        var ps = new kakao.maps.services.Places(); 
        // 키워드로 장소를 검색
        
        ps.keywordSearch(query + ' ', placesSearchCB);

        // 키워드 검색 완료 시 호출되는 콜백함수
        function placesSearchCB (data, status, pagination) {
            if (status === kakao.maps.services.Status.OK) {
                var bounds = new kakao.maps.LatLngBounds();
                
                for (let i=0; i<data.length; i++) {
                    displayMarker(data[i]);
                    bounds.extend(new kakao.maps.LatLng(data[i].y, data[i].x));
                }

                // 검색된 장소 위치를 기준으로 지도 범위를 재설정
                map.setBounds(bounds);

            }
        }

        
    // 지도에 마커를 표시하는 함수입니다
    function displayMarker(place) {
        // 마커를 생성하고 지도에 표시합니다
        var marker = new kakao.maps.Marker({
            map: map,
            position: new kakao.maps.LatLng(place.y, place.x) 
        });

        // 마커에 클릭이벤트를 등록합니다
        kakao.maps.event.addListener(marker, 'click', function() {
            // 마커를 클릭하면 장소명이 인포윈도우에 표출됩니다
            infowindow.setContent('<div style="padding:5px;font-size:12px;">' + place.place_name + '</div>');
            infowindow.open(map, marker);
        });
    }

              });
            } else {
              const s = parseInt(target.status / 100);
              let errMsg = null;
              if (s == 4) {
                errMsg =
                  "[" +
                  target.status +
                  "]" +
                  target.statusText +
                  "-요청 주소가 잘못되었습니다.";
              } else if (s == 5) {
                errMsg =
                  "[" +
                  target.status +
                  "]" +
                  target.statusText +
                  "-서버의 응답이 없습니다.";
              } else {
                errMsg =
                  "[" +
                  target.status +
                  "]" +
                  target.statusText +
                  "-요청에 실패했습니다.";
              }
              alert(errMsg);
            }
          }
        };

        xhr.open(method, url);
        xhr.setRequestHeader(
          "Authorization",
          "KakaoAK fc4ae9f65a8ff5a3a85b0ed5a6cf19cd"
        );
        xhr.send();
      }

      document.querySelector("#searchForm").addEventListener("submit", (e) => {
        e.preventDefault();
        const queryField = document.querySelector("#query");
        const query = queryField.value.trim();

        console.log(query);
        if (!query) {
          alert("검색하세요");
          queryField.focus();
          return;
        }
        get_map_search(query);
      });
    
   
        const map_display = document.getElementById('map'),
              options = {
                        center: new kakao.maps.LatLng(37.566826, 126.9786567),
                        level: 3
                        };
                            
        // 지도를 생성합니다    
        var map = new kakao.maps.Map(map_display, options); 

        
        // 마커 배열 생성
        const markers = [];

        // 검색 결과 마커 띄우기
        function popPlaces(place) {
            const list = document.getElementById('placelist');
            const menu = document.getElementById('map_container');
            const bounds = new kakao.maps.LatLngBounds();
            const fragment = document.createDocumentFragment();
            listStr = '';

            removeAllChildNods(list);

            removeMarker();

            for(let i = 0; i<place.length; i++) {
                const item = getList(i, palces[i]);
                const placePosition = new kakao.maps.LatLng(places[i].y, places[i].x);
                const marker = addMarker(placePosition, i);
                
                // 지도 범위 재설정
                bounds.extend(placePosition);

                (function(marker, title) {
                    kakao.maps.event.addListener(marker, 'mouseover', function() {
                        displayInfowindow(marker, title);
                    });

                    kakao.maps.event.addListener(marker, 'mouseout', function() {
                        infowindow.close();
                    });

                    item.onmouseover = function() {
                        displayInfowindow(marker, title);
                    };

                    item.onmouseout = function() {
                        infowindow.close();
                    };
                }) (marker, places[i].place_name);

                fragment.appendChild(item);
            }

            list.appendChild(fragment);
            menu.scrollTop = 0;

            map.setBounds(bounds);
        }
        // 검색 결과 항목으로 반환
        function getList(index, places) {
            const el = document.createElement('li')
            const itemStr = '<span class="markerbg marker_' + (index+1) + '"></span>'
                            + '<div class="info">'
                            + '<h5>' + places.place_name + '</h5>';
            
            if(places.road_address_name) {
                itemStr += '<span>' + palces.road_address_name + '</span>' +
                            '<span class="jibun gray">' + places.address_name + '</span>';
            } else {
                itemStr += '<span>' + places.address_name + '</span>';
            }

            itemStr += '<span class="tel">' + places.phone + '</span>' + '</div>';

            el.innerHTML = itemStr;
            el.className = 'item';

            return el;
        }

        //마커를 지도에 표시
        function addMarker(position, idx, title) {
            const imageSrc = 'https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/marker_number_blue.png';
            const imageSize = new kakao.maps.Size(36, 37);
            const imgOptions = {
                spriteSize : new kakao.maps.Size(36, 691), 
                spriteOrigin : new kakao.maps.Point(0, (idx*46)+10),
                offset: new kakao.maps.Point(13, 37)
            };
            const markerImage = new kakao.maps.MarkerImage(imageSrc, imageSize, imgOptions);
            const marker = new kakao.maps.Marker({
                            position: position,
                            image: markerImage
                        });

            marker.setMap(map);
            markers.push(marker);

            return marker;
        }
        function removeMarker() {
            for(let i = 0; i < markers.length; i++) {
                markers[i].setMap(null);
            }
            markers = [];
        }

        // 지도에 마커와 인포윈도우를 표시
        function displayMarkerWithMessage(locPosition, message) {

            // 마커 생성
            let marker = new kakao.maps.Marker({  
                map: map, 
                position: locPosition
            }); 

            let iwContent = message,
                iwRemoveable = true;

            // 인포윈도우 생성
            let infowindow = new kakao.maps.InfoWindow({
                content : iwContent,
                removable : iwRemoveable
            });

            infowindow.open(map, marker);

            // 지도 좌표를 접속위치로 변경
            map.setCenter(locPosition);      
        }   

         // 지도에 마커를 표시하는 함수입니다
      function displayMarker(place) {
        // 마커를 생성하고 지도에 표시합니다
        var marker = new kakao.maps.Marker({
          map: map,
          position: new kakao.maps.LatLng(place.y, place.x),
        });

        // 마커에 클릭이벤트를 등록합니다
        kakao.maps.event.addListener(marker, "click", function () {
          // 마커를 클릭하면 장소명이 인포윈도우에 표출됩니다
          infowindow.setContent(
            '<div style="padding:5px;font-size:12px;">' +
              place.place_name +
              "</div>"
          );
          infowindow.open(map, marker);
        });
      }

        const loc_btn = document.querySelector("#loc_btn");

        loc_btn.addEventListener("click", (e) => {
            //현재 위치 추적
            if(navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    let lat = position.coords.latitude;
                    let lon = position.coords.longitude;

                    const locPosition = new kakao.maps.LatLng(lat, lon);

                    map.setCenter(locPosition);  
                
                    map.setLevel(4, {animate: true});
                });
            } else {
                let locPosition = new kakao.maps.LatLng(37.566826, 126.9786567);
                const message = '현재 위치 사용 불가'

                displayMarkerWithMessage(locPosition, message);
            }
        });
    
            
    </script>
</body>
</html>