<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=90b8e6fd2a9909e4b0de7508dd8dcb62&libraries=services"></script>

    <style>
        body {
            width: 100%;
            margin: 30px;
        }

        #content #map {
            height: 700px;
            width: 500px;
            float: right;
            margin-right: 100px;
        }
    </style>

</head>
<body>
    <header id="header">
        <h1>kakao 맛집 검색</h1>
    </header>
    <content id="content">
        <nav class="search-container">
            <form id="searchForm">
                <input type="search" id="query" placeholder="키워드를 입력해주세요" />
                <button type="submit">검색</button>
            </form>
        </nav>
    
        <div class="list-container">
            <ul id="list"></ul>
        </div>
    
        <div class="map_container">
            <div id="map">
            </div>
        </div>
    </content>
    <footer id="footer"></footer>

    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=90b8e6fd2a9909e4b0de7508dd8dcb62&libraries=services"></script>
    <script>
      function get_map_search(query) {
        const xhr = new XMLHttpRequest();
        const method = "GET";
        const url =
          "https://dapi.kakao.com/v2/local/search/keyword.json?query=" + query;

        xhr.onreadystatechange = (e) => {
          const { target } = e;

          if (target.readyState == XMLHttpRequest.DONE) {
            if (target.status == 200) {
              const req = JSON.parse(target.response);
              const listBody = document.querySelector("#list");
              listBody.innerHTML = "";
              req.documents.map((v, i) => {
                console.log(v);

               
              });
            } else {
              const s = parseInt(target.status / 100);
              let errMsg = null;
              if (s == 4) {
                errMsg =
                  "[" +
                  target.status +
                  "]" +
                  target.statusText +
                  "-요청 주소가 잘못되었습니다.";
              } else if (s == 5) {
                errMsg =
                  "[" +
                  target.status +
                  "]" +
                  target.statusText +
                  "-서버의 응답이 없습니다.";
              } else {
                errMsg =
                  "[" +
                  target.status +
                  "]" +
                  target.statusText +
                  "-요청에 실패했습니다.";
              }
              alert(errMsg);
            }
          }
        };

        xhr.open(method, url);
        xhr.setRequestHeader(
          "Authorization",
          "KakaoAK fc4ae9f65a8ff5a3a85b0ed5a6cf19cd"
        );
        xhr.send();
      }
      document.querySelector("#searchForm").addEventListener("submit", (e) => {
        e.preventDefault();
        const queryField = document.querySelector("#query");
        const query = queryField.value.trim();

        if (!query) {
          alert("검색하세요");
          queryField.focus();
          return;
        }
        get_map_search(query);
      });
    
        // 지도 띄우기
        const map_display = document.getElementById('map'),
              options = {
                        center: new kakao.maps.LatLng(37.566826, 126.9786567),
                        level: 3
                        };
 
        const map = new kakao.maps.Map(map_display, options);
        
        // 마커 배열 생성
        const markers = [];

        // 검색 결과 마커 띄우기
        function popPlaces(place) {
            const list = document.getElementById('placelist');
            const menu = document.getElementById('map_container');
            const bounds = new kakao.maps.LatLngBounds();
            const fragment = document.createDocumentFragment();
            listStr = '';

            removeAllChildNods(list);

            removeMarker();

            for(let i = 0; i<place.length; i++) {
                const item = getListItem(i, palces[i]);
                const placePosition = new kakao.maps.LatLng(places[i].y, places[i].x);
                const marker = addMarker(placePosition, i);
                
                // 지도 범위 재설정
                bounds.extend(placePosition);

                (function(marker, title) {
                    kakao.maps.event.addListener(marker, 'mouseover', function() {
                        displayInfowindow(marker, title);
                    });

                    kakao.maps.event.addListener(marker, 'mouseout', function() {
                        infowindow.close();
                    });

                    item.onmouseover = function() {
                        displayInfowindow(marker, title);
                    };

                    item.onmouseout = function() {
                        infowindow.close();
                    };
                }) (marker, places[i].place_name);

                fragment.appendChild(item);
            }

            list.appendChild(fragment);
            menu.scrollTop = 0;

            map.setBounds(bounds);
        }
        // 검색 결과 항목으로 반환
        function getList(index, places) {
            const el = document.createElement('li')
            const itemStr = '<span class="markerbg marker_' + (index+1) + '"></span>'
                            + '<div class="info">'
                            + '<h5>' + places.place_name + '</h5>';
            
            if(places.road_address_name) {
                itemStr += '<span>' + palces.road_address_name + '</span>' +
                            '<span class="jibun gray">' + places.address_name + '</span>';
            } else {
                itemStr += '<span>' + places.address_name + '</span>';
            }

            itemStr += '<span class="tel">' + places.phone + '</span>' + '</div>';

            el.innerHTML = itemStr;
            el.className = 'item';

            return el;

            //마커를 지도에 표시
            function addMarker(position, idx, title) {
                const imageSrc = 'https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/marker_number_blue.png';
                const imageSize = new kakao.maps.Size(36, 37);
                const imgOptions = {
                    spriteSize : new kakao.maps.Size(36, 691), 
                    spriteOrigin : new kakao.maps.Point(0, (idx*46)+10),
                    offset: new kakao.maps.Point(13, 37)
                };
                const markerImage = new kakao.maps.MarkerImage(imageSrc, imageSize, imgOptions);
                const marker = new kakao.maps.Marker({
                                position: position,
                                image: markerImage
                            });

                marker.setMap(map);
                markers.push(marker);

                return marker;
            }

            
        }
    </script>
</body>
</html>